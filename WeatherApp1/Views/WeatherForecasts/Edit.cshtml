@model WeatherApp1.Models.WeatherForecast

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>WeatherForecast</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            <div class="form-group">
                <label asp-for="DayOfWeek" class="control-label">Select Day</label>
                <select asp-for="DayOfWeek" class="form-control">
                    <option value="">-- Select Day --</option>
                    <option value="Sunday">Sunday</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                </select>
                <span asp-validation-for="DayOfWeek" class="text-danger"></span>
            </div>
            <fieldset class="border border-primary rounded p-3 mb-3">
                <legend class="float-none w-auto px-2 text-primary">Описание на времето</legend>
                <div class="d-flex align-items-center">
                    <input type="checkbox"
                           value="предимно"
                           name="mainly"
                           id="mainly"
                           class="btn-check" />
                    <label for="mainly"
                           class="btn btn-outline-secondary me-2">
                        предимно
                    </label>
                    <div class="btn-group-vertical me-2">
                        <input type="radio"
                               value="слънчево"
                               name="sunnyOrCloudily"
                               id="sunny"
                               class="btn-check" />
                        <label for="sunny"
                               class="btn btn-outline-secondary mb-2">
                            слънчево
                        </label>
                        <input type="radio"
                               value="облачно"
                               name="sunnyOrCloudily"
                               id="cloudily"
                               class="btn-check" />
                        <label for="cloudily"
                               class="btn btn-outline-secondary">
                            облачно
                        </label>
                    </div>
                    <input type="checkbox"
                           value="кратък"
                           name="brief"
                           id="brief"
                           class="btn-check" />
                    <label for="brief"
                           class="btn btn-outline-secondary me-2">
                        кратък
                    </label>
                    <div class="btn-group-vertical">
                        <input type="checkbox"
                               value="дъжд"
                               name="rainOrSnow"
                               id="rain"
                               class="btn-check" />
                        <label for="rain"
                               class="btn btn-outline-secondary mb-2">
                            дъжд
                        </label>
                        <input type="checkbox"
                               value="сняг"
                               name="rainOrSnow"
                               id="snow"
                               class="btn-check" />
                        <label for="snow"
                               class="btn btn-outline-secondary">
                            сняг
                        </label>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label asp-for="WeatherDescription" class="control-label"></label>
                    <input asp-for="WeatherDescription" id="weatherDescriptionInput" readonly class="form-control-plaintext" />
                    <span asp-validation-for="WeatherDescription" id="weatherDescriptionSpan" class="text-danger"></span>
                </div>
            </fieldset>
            <div class="form-group">
                <label asp-for="MaxTemperature" class="control-label"></label>
                <input asp-for="MaxTemperature" class="form-control" />
                <span asp-validation-for="MaxTemperature" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="MinTemperature" class="control-label"></label>
                <input asp-for="MinTemperature" class="form-control" />
                <span asp-validation-for="MinTemperature" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="WindSpeed" class="control-label"></label>
                <input asp-for="WindSpeed" class="form-control" />
                <span asp-validation-for="WindSpeed" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="WindDirection" class="control-label">Посока на вятъра</label>
                <select asp-for="WindDirection" class="form-control">
                    <option value="">-- избери посока на вятъра --</option>
                    <option value="Север">Север</option>
                    <option value="Североизток">Североизток</option>
                    <option value="Изток">Изток</option>
                    <option value="Югоизток">Югоизток</option>
                    <option value="Юг">Юг</option>
                    <option value="Югозапад">Югозапад</option>
                    <option value="Запад">Запад</option>
                    <option value="Северозапад">Северозапад</option>
                </select>
                <span asp-validation-for="WindDirection" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="RainProbability" class="control-label"></label>
                <input asp-for="RainProbability" class="form-control" />
                <span asp-validation-for="RainProbability" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Sunrise" class="control-label"></label>
                <input asp-for="Sunrise" class="form-control" />
                <span asp-validation-for="Sunrise" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Sunset" class="control-label"></label>
                <input asp-for="Sunset" class="form-control" />
                <span asp-validation-for="Sunset" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="MoonPhase" class="control-label">Фаза на луната</label>
                <select asp-for="MoonPhase" class="form-control">
                    <option value="">-- избери фаза на луната --</option>
                    <option value="новолуние">новолуние</option>
                    <option value="изгряващ полумесец">изгряващ полумесец</option>
                    <option value="първа четвърт">първа четвърт</option>
                    <option value="растяща луна">растяща луна</option>
                    <option value="пълнолуние">пълнолуние</option>
                    <option value="намаляваща луна">намаляваща луна</option>
                    <option value="трета четвърт">трета четвърт</option>
                    <option value="залязващ полумесец">залязващ полумесец</option>
                </select>
                <span asp-validation-for="MoonPhase" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Back to List</a>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        const weatherCode = [0, 0, 0, 0];
        let errorMessage;

        $(document).ready(function () {
            $("#mainly").on("click", function () {
                weatherCode[0] = weatherCode[0] == 0 ? 1 : 0;
                showDescription();
            });

            $("[name='sunnyOrCloudily']").on("click", function () {
                weatherCode[1] = $(this).attr("id") == "sunny" ? 1 : 2;
                showDescription();
            });

            $("#brief").on("click", function () {
                weatherCode[2] = weatherCode[2] == 0 ? 1 : 0;
                showDescription();
            });

            $("[name='rainOrSnow']").on("click", function () {
                if ($(this).attr("id") == "rain" && $("#rain").is(":checked")) {
                    weatherCode[3] = 1;
                    $("#snow").prop("checked", false);
                }
                else if ($(this).attr("id") == "snow" && $("#snow").is(":checked")) {
                    weatherCode[3] = 2;
                    $("#rain").prop("checked", false);
                }
                else {
                    weatherCode[3] = 0;
                }

                showDescription();
            });

            // ✅ Corrected: Validate on form submission
            $("form").on("submit", function (event) {
                let weatherIsValid = validateWeather();

                if (!weatherIsValid) {
                    $("#weatherDescriptionSpan").text(errorMessage);
                    event.preventDefault(); // Prevents form submission
                } else {
                    $("#weatherDescriptionSpan").empty(); // Clears previous errors
                }
            });

            function showDescription() {
                let description = "";

                if (weatherCode[0] == 1) {
                    description = description.concat("предимно ");
                }

                switch (weatherCode[1]) {
                    case 1: description = description.concat("слънчево "); break;
                    case 2: description = description.concat("облачно "); break;
                }

                if (weatherCode[2] == 1) {
                    description = description.concat("кратък ");
                }

                switch (weatherCode[3]) {
                    case 1: description = description.concat("дъжд"); break;
                    case 2: description = description.concat("сняг"); break;
                }

                description = description.trimEnd();

                $("#weatherDescriptionInput").val(description);
            }

            function validateWeather() {
                if (weatherCode[0] == 0 && weatherCode[1] == 0 && weatherCode[2] == 0 && weatherCode[3] == 0) {
                    errorMessage = "Не сте въвели никакво описание.";
                    return false;
                }
                else if ((weatherCode[1] == 1 && weatherCode[3] == 1) ||
                    (weatherCode[1] == 1 && weatherCode[3] == 2)) {
                    errorMessage = "Въвели сте нелогично описание.";
                    return false;
                }
                else if (weatherCode[0] == 1 && weatherCode[1] == 0) {
                    errorMessage = "Не сте уточнили за какво се отнася наречието \"предимно\".";
                    return false;
                }
                else if (weatherCode[2] == 1 && weatherCode[3] == 0) {
                    errorMessage = "Не сте уточнили за какво се отнася прилагателното \"кратък\".";
                    return false;
                }
                else if (weatherCode[1] == 0) {
                    errorMessage = "Липсва едно от двете задължителни прилагателни: \"слънчево\" или \"облачно\".";
                    return false;
                }

                return true;
            }
        });
    </script>
}
